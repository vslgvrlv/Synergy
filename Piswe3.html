<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Corona Import — Unit Economics Dashboard</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#e7ecff;
      --muted:#aab3d7;
      --line:rgba(255,255,255,.10);
      --good:#32d583;
      --bad:#ff6b6b;

      --c-supplier:#7aa7ff;
      --c-gov:#ffd1d1;
      --c-log:#ffcc66;
      --c-ops:#ff8fb1;
      --c-profit:#c6f6d5;
      --c-loss:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, #14204a 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1320px;margin:0 auto;padding:20px}
    h1{margin:0 0 8px;font-size:20px;font-weight:750}
    .sub{color:var(--muted);font-size:13px;line-height:1.35;margin-bottom:14px}

    .grid{
      display:grid;
      grid-template-columns: 430px 1fr;
      gap:14px;
    }
    @media (max-width: 1040px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
      color:#f2f4ff;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      margin:8px 0;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid transparent;
      transition: border-color .12s ease, background .12s ease;
    }
    .row label{flex:1;color:var(--muted);font-size:12px}
    .row input, .row select{
      width:178px;
      background:#0b1430;
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      outline:none;
      font-size:13px;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    .row input:focus, .row select:focus{border-color:rgba(255,255,255,.25)}
    .row.active{
      border-color: rgba(122,167,255,.65);
      background: rgba(122,167,255,.06);
    }
    .row.active input, .row.active select{
      border-color: rgba(122,167,255,.75);
      box-shadow: 0 0 0 3px rgba(122,167,255,.15);
    }

    .help{color:var(--muted);font-size:11px;line-height:1.35;margin-top:8px}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      background:#0b1430;
      color:var(--text);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
    }
    button:hover{border-color:rgba(255,255,255,.25)}

    .kpi{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-bottom:12px;
    }
    @media (max-width: 1040px){
      .kpi{grid-template-columns:1fr}
    }
    .k{
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .k .t{color:var(--muted);font-size:12px;margin-bottom:6px}
    .k .v{font-size:18px;font-weight:800}
    .k .s{color:var(--muted);font-size:12px;margin-top:4px}
    .ok{color:var(--good)}
    .bad{color:var(--bad)}

    .sectionTitle{margin:0 0 8px;font-size:13px;color:#f2f4ff;font-weight:750}

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color:var(--muted);font-weight:700;background:rgba(255,255,255,.03)}
    .table tr:last-child td{border-bottom:none}

    .mono{font-variant-numeric: tabular-nums}

    /* Visualization */
    .vizCard{padding:16px}
    .vizHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .vizHeader .left h2{margin:0 0 6px}
    .vizHeader .left .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      margin:0;
    }
    .selBox{
      min-width: 340px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:10px;
    }
    @media (max-width: 1040px){
      .selBox{min-width:auto}
      .vizHeader{flex-direction:column}
    }
    .selBox .title{color:var(--muted);font-size:12px;margin-bottom:6px}
    .selBox .name{font-weight:800;margin-bottom:6px}
    .selBox .vals{color:var(--muted);font-size:12px;line-height:1.35}

    .barWrap{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.03);
    }
    .barTitle{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      align-items:center;
    }
    .barTitle .l{font-weight:750;font-size:12px;color:#f2f4ff}
    .barTitle .r{font-size:12px;color:var(--muted)}
    .bar{
      height:22px;
      width:100%;
      background:rgba(255,255,255,.06);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .seg{
      height:100%;
      display:inline-block;
      cursor:pointer;
      position:relative;
      outline:none;
    }
    .seg:focus{box-shadow: 0 0 0 3px rgba(122,167,255,.20); border-radius:999px}
    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .lg{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:3px;background:#fff;opacity:.9}

    .detailGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 1040px){
      .detailGrid{grid-template-columns:1fr 1fr}
    }
    .tile{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:10px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
      min-height:64px;
    }
    .tile:hover{border-color: rgba(255,255,255,.22)}
    .tile.active{
      border-color: rgba(122,167,255,.75);
      background: rgba(122,167,255,.06);
    }
    .tile .t{color:var(--muted);font-size:11px;margin-bottom:6px}
    .tile .v{font-size:14px;font-weight:800}
    .tile .c{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pill{width:10px;height:10px;border-radius:3px;background:#fff;opacity:.9}

    .small{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.35}

    /* Tooltip */
    #tooltip{
      position:fixed;
      z-index:9999;
      pointer-events:none;
      display:none;
      max-width: 340px;
      background: rgba(10,16,34,.95);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 14px 28px rgba(0,0,0,.35);
      color: var(--text);
      font-size: 12px;
      line-height: 1.35;
    }
    #tooltip .h{font-weight:800;margin-bottom:6px}
    #tooltip .m{color:var(--muted)}
  </style>
</head>
<body>
  <div id="tooltip"></div>

  <div class="wrap">
    <h1>Corona Import — калькулятор/дашборд</h1>
    <div class="sub">
      P&L считается «без НДС». Hover = подсветка+tooltip (без скролла). Click = перейти к вводу (скролл+фокус).
    </div>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <h2>1) Вводные</h2>

        <div class="row" data-row="sellPriceVat"><label>Цена продажи X5 (₽/бут, с НДС)</label>
          <input id="sellPriceVat" type="number" step="0.01" value="100"></div>
        <div class="row" data-row="vatRate"><label>НДС (доля)</label>
          <input id="vatRate" type="number" step="0.001" value="0.22"></div>

        <div class="row" data-row="bottlesPerContainer"><label>Бутылок в контейнере 40ft</label>
          <input id="bottlesPerContainer" type="number" step="1" value="46080"></div>
        <div class="row" data-row="containersPerMonth"><label>Контейнеров в месяц</label>
          <input id="containersPerMonth" type="number" step="1" value="120"></div>

        <div class="hr"></div>
        <h2>2) Целевая прибыль</h2>

        <div class="row" data-row="targetNetProfitYear"><label>Целевая ЧП (₽/год)</label>
          <input id="targetNetProfitYear" type="number" step="1000000" value="300000000"></div>
        <div class="row" data-row="profitTaxRate"><label>Налог на прибыль (доля)</label>
          <input id="profitTaxRate" type="number" step="0.001" value="0.25"></div>

        <div class="hr"></div>
        <h2>3) Гос.платежи</h2>

        <div class="row" data-row="bottleLiters"><label>Литров в бутылке</label>
          <input id="bottleLiters" type="number" step="0.01" value="0.33"></div>
        <div class="row" data-row="exciseRubPerLiter"><label>Акциз (₽/литр)</label>
          <input id="exciseRubPerLiter" type="number" step="0.01" value="33"></div>

        <div class="row" data-row="dutyEurPerLiter"><label>Пошлина (€/литр)</label>
          <input id="dutyEurPerLiter" type="number" step="0.0001" value="0.018"></div>
        <div class="row" data-row="eurRub"><label>Курс EUR/RUB</label>
          <input id="eurRub" type="number" step="0.01" value="100"></div>

        <div class="row" data-row="czCodeRub"><label>Код ЧЗ (₽/бут, без НДС)</label>
          <input id="czCodeRub" type="number" step="0.01" value="0.50"></div>

        <div class="hr"></div>
        <h2>4) Наши расходы и термины (EXW/FOB/CIF)</h2>

        <div class="row" data-row="originRubPerContainer"><label>Origin/local (EXW→FOB) (₽/конт)</label>
          <input id="originRubPerContainer" type="number" step="1000" value="622544"></div>

        <div class="row" data-row="oceanRubPerContainer"><label>Ocean freight (₽/конт)</label>
          <input id="oceanRubPerContainer" type="number" step="1000" value="0"></div>
        <div class="row" data-row="insuranceRubPerContainer"><label>Страхование (₽/конт)</label>
          <input id="insuranceRubPerContainer" type="number" step="1000" value="0"></div>

        <div class="row" data-row="destPortUsdPerContainer"><label>Destination port (USD/конт)</label>
          <input id="destPortUsdPerContainer" type="number" step="1" value="550"></div>
        <div class="row" data-row="usdRub"><label>Курс USD/RUB</label>
          <input id="usdRub" type="number" step="0.01" value="100"></div>

        <div class="row" data-row="inlandRubPerContainer"><label>Внутр. логистика до склада X5 (₽/конт)</label>
          <input id="inlandRubPerContainer" type="number" step="1000" value="52000"></div>

        <div class="row" data-row="customsFeeRubPerContainer"><label>Таможенный сбор (₽/конт)</label>
          <input id="customsFeeRubPerContainer" type="number" step="1000" value="12000"></div>
        <div class="row" data-row="brokerFeeRubPerContainer"><label>Брокер (₽/конт)</label>
          <input id="brokerFeeRubPerContainer" type="number" step="1000" value="15000"></div>

        <div class="row" data-row="markingServiceRubPerBottle"><label>Маркировка как услуга (₽/бут, без НДС)</label>
          <input id="markingServiceRubPerBottle" type="number" step="0.01" value="8.00"></div>
        <div class="row" data-row="egaisOpsRubPerBottle"><label>ЕГАИС/операционка (₽/бут, без НДС)</label>
          <input id="egaisOpsRubPerBottle" type="number" step="0.01" value="0.00"></div>
        <div class="row" data-row="otherOpsRubPerBottle"><label>Прочие операц. (₽/бут, без НДС)</label>
          <input id="otherOpsRubPerBottle" type="number" step="0.01" value="0.00"></div>

        <div class="hr"></div>
        <h2>5) Факт: цена поставщика</h2>

        <div class="row" data-row="supplierTerm"><label>Термин цены поставщика</label>
          <select id="supplierTerm">
            <option value="EXW">EXW</option>
            <option value="FOB">FOB</option>
            <option value="CIF">CIF</option>
          </select>
        </div>

        <div class="row" data-row="supplierPriceRubPerBottle"><label>Цена поставщика (₽/бут, без НДС)</label>
          <input id="supplierPriceRubPerBottle" type="number" step="0.01" value="0.00"></div>

        <div class="btnRow">
          <button id="btnReset">Сбросить</button>
          <button id="btnSave">Сохранить</button>
          <button id="btnLoad">Загрузить</button>
          <button id="btnClearSel">Снять выделение</button>
        </div>

        <div class="help">
          Hover на визуализации — подсветка и подсказка. Click — закрепление и переход к нужным полям ввода.
        </div>
      </div>

      <!-- OUTPUTS -->
      <div>
        <!-- MAIN VIS -->
        <div class="card vizCard">
          <div class="vizHeader">
            <div class="left">
              <h2>Визуализация цены (главное)</h2>
              <p class="note">
                Расклад цены «без НДС» по термину поставщика (<span class="mono" id="outTerm">—</span>).
              </p>
            </div>
            <div class="selBox" id="selBox">
              <div class="title">Выбранный элемент</div>
              <div class="name mono" id="selName">—</div>
              <div class="vals mono" id="selVals">Наведись или кликни по сегменту/плитке</div>
            </div>
          </div>

          <div class="barWrap">
            <div class="barTitle">
              <div class="l">Цена продажи без НДС = 100%</div>
              <div class="r mono" id="outSellExVatInline">—</div>
            </div>
            <div class="bar" id="mainBar" aria-label="stacked bar"></div>

            <div class="legend">
              <div class="lg"><span class="dot" style="background:var(--c-supplier)"></span>Поставщик</div>
              <div class="lg"><span class="dot" style="background:var(--c-gov)"></span>Гос.платежи</div>
              <div class="lg"><span class="dot" style="background:var(--c-log)"></span>Логистика/таможня</div>
              <div class="lg"><span class="dot" style="background:var(--c-ops)"></span>Маркировка/операции</div>
              <div class="lg"><span class="dot" style="background:var(--c-profit)"></span>Прибыль до налога</div>
              <div class="lg"><span class="dot" style="background:var(--c-loss)"></span>Убыток</div>
            </div>

            <div class="small" id="mainBarText">—</div>

            <div class="hr"></div>
            <div class="sectionTitle">Детализация (кликабельные элементы)</div>
            <div class="detailGrid" id="detailGrid"></div>
            <div class="small">Hover = подсветка/tooltip. Click = закрепить и перейти к вводу.</div>
          </div>
        </div>

        <!-- KPIs -->
        <div class="card">
          <h2>Ключевые метрики</h2>

          <div class="kpi">
            <div class="k">
              <div class="t">Цена продажи без НДС (₽/бут)</div>
              <div class="v mono" id="outSellExVat">—</div>
              <div class="s">P&L</div>
            </div>
            <div class="k">
              <div class="t">Годовой объём (бут / конт)</div>
              <div class="v mono" id="outVolumeYear">—</div>
              <div class="s">12 мес</div>
            </div>
            <div class="k">
              <div class="t">Треб. прибыль до налога (₽/бут)</div>
              <div class="v mono" id="outTargetPBTPerBottle">—</div>
              <div class="s">под цель ЧП</div>
            </div>
            <div class="k">
              <div class="t">Статус к цели (ЧП/год)</div>
              <div class="v mono" id="goalKpi">—</div>
              <div class="s mono" id="goalKpiSub">—</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="sectionTitle">Потолок цены поставщика (₽/бут, без НДС) под цель ЧП</div>
          <table class="table">
            <thead>
              <tr>
                <th>Термин</th>
                <th>Макс. цена</th>
                <th>Что оплачиваем сверху</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="mono">EXW</td>
                <td class="mono" id="maxEXW">—</td>
                <td>origin + ocean + insurance + порт РФ + РФ логистика + таможня + операции</td>
              </tr>
              <tr>
                <td class="mono">FOB</td>
                <td class="mono" id="maxFOB">—</td>
                <td>ocean + insurance + порт РФ + РФ логистика + таможня + операции</td>
              </tr>
              <tr>
                <td class="mono">CIF</td>
                <td class="mono" id="maxCIF">—</td>
                <td>порт РФ + РФ логистика + таможня + операции</td>
              </tr>
            </tbody>
          </table>

          <div class="hr"></div>

          <div class="sectionTitle">Факт-экономика при введённой цене поставщика</div>
          <table class="table">
            <thead>
              <tr>
                <th>Показатель</th>
                <th>На бут</th>
                <th>На конт</th>
                <th>На год</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Выручка (без НДС)</td>
                <td class="mono" id="revBottle">—</td>
                <td class="mono" id="revCont">—</td>
                <td class="mono" id="revYear">—</td>
              </tr>
              <tr>
                <td>Себестоимость</td>
                <td class="mono" id="costBottle">—</td>
                <td class="mono" id="costCont">—</td>
                <td class="mono" id="costYear">—</td>
              </tr>
              <tr>
                <td>Прибыль до налога</td>
                <td class="mono" id="pbtBottle">—</td>
                <td class="mono" id="pbtCont">—</td>
                <td class="mono" id="pbtYear">—</td>
              </tr>
              <tr>
                <td>Чистая прибыль</td>
                <td class="mono" id="netBottle">—</td>
                <td class="mono" id="netCont">—</td>
                <td class="mono" id="netYear">—</td>
              </tr>
            </tbody>
          </table>

          <div class="hr"></div>
          <div class="sectionTitle">Легенда переменных</div>
          <table class="table">
            <thead><tr><th>Переменная</th><th>Смысл</th></tr></thead>
            <tbody>
              <tr><td class="mono">sellPriceVat, vatRate</td><td>Цена X5 с НДС и ставка НДС</td></tr>
              <tr><td class="mono">bottlesPerContainer, containersPerMonth</td><td>Упаковка и объём</td></tr>
              <tr><td class="mono">targetNetProfitYear, profitTaxRate</td><td>Цель ЧП и ставка налога на прибыль</td></tr>
              <tr><td class="mono">exciseRubPerLiter, bottleLiters</td><td>Акциз и литраж</td></tr>
              <tr><td class="mono">dutyEurPerLiter, eurRub</td><td>Пошлина и курс EUR</td></tr>
              <tr><td class="mono">czCodeRub</td><td>Код Честного знака</td></tr>
              <tr><td class="mono">originRubPerContainer</td><td>Origin/local для EXW</td></tr>
              <tr><td class="mono">oceanRubPerContainer, insuranceRubPerContainer</td><td>Океан и страховка</td></tr>
              <tr><td class="mono">destPortUsdPerContainer, usdRub</td><td>Порт РФ (THC) и курс USD</td></tr>
              <tr><td class="mono">inlandRubPerContainer</td><td>Логистика РФ</td></tr>
              <tr><td class="mono">customsFeeRubPerContainer, brokerFeeRubPerContainer</td><td>Тамож. сбор и брокер</td></tr>
              <tr><td class="mono">markingServiceRubPerBottle</td><td>Маркировка как услуга</td></tr>
              <tr><td class="mono">egaisOpsRubPerBottle, otherOpsRubPerBottle</td><td>ЕГАИС/операции и прочее</td></tr>
              <tr><td class="mono">supplierTerm, supplierPriceRubPerBottle</td><td>Термин и цена поставщика</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const defaults = {
    sellPriceVat: 100,
    vatRate: 0.22,
    bottlesPerContainer: 46080,
    containersPerMonth: 120,
    targetNetProfitYear: 300000000,
    profitTaxRate: 0.25,
    bottleLiters: 0.33,
    exciseRubPerLiter: 33,
    dutyEurPerLiter: 0.018,
    eurRub: 100,
    czCodeRub: 0.50,
    oceanRubPerContainer: 0,
    insuranceRubPerContainer: 0,
    originRubPerContainer: 622544,
    destPortUsdPerContainer: 550,
    usdRub: 100,
    inlandRubPerContainer: 52000,
    customsFeeRubPerContainer: 12000,
    brokerFeeRubPerContainer: 15000,
    markingServiceRubPerBottle: 8.00,
    egaisOpsRubPerBottle: 0.00,
    otherOpsRubPerBottle: 0.00,
    supplierTerm: "EXW",
    supplierPriceRubPerBottle: 0.00
  };

  let pinnedKey = null; // clicked element is pinned

  function num(v){ return Number(v || 0); }
  function fmt(n, digits=2){
    if (!isFinite(n)) return "—";
    const sign = n < 0 ? "-" : "";
    n = Math.abs(n);
    return sign + n.toLocaleString("ru-RU", {minimumFractionDigits: digits, maximumFractionDigits: digits});
  }
  function fmt0(n){
    if (!isFinite(n)) return "—";
    return n.toLocaleString("ru-RU", {maximumFractionDigits:0});
  }

  function getInputs(){
    const ids = Object.keys(defaults);
    const data = {};
    for (const id of ids){
      const el = $(id);
      if (!el) continue;
      if (el.tagName === "SELECT") data[id] = el.value;
      else data[id] = num(el.value);
    }
    return data;
  }

  function clearHighlights(){
    document.querySelectorAll(".row").forEach(r => r.classList.remove("active"));
    document.querySelectorAll(".tile").forEach(t => t.classList.remove("active"));
  }

  const keyToInputs = {
    supplier_total: ["supplierPriceRubPerBottle","supplierTerm"],
    gov_total: ["exciseRubPerLiter","dutyEurPerLiter","eurRub","czCodeRub","bottleLiters"],
    log_total: ["originRubPerContainer","oceanRubPerContainer","insuranceRubPerContainer","destPortUsdPerContainer","usdRub","inlandRubPerContainer","customsFeeRubPerContainer","brokerFeeRubPerContainer"],
    ops_total: ["markingServiceRubPerBottle","egaisOpsRubPerBottle","otherOpsRubPerBottle"],
    profit: ["targetNetProfitYear","profitTaxRate"],
    loss: ["targetNetProfitYear","profitTaxRate"],

    excise: ["exciseRubPerLiter","bottleLiters"],
    duty: ["dutyEurPerLiter","eurRub","bottleLiters"],
    czcode: ["czCodeRub"],

    origin: ["originRubPerContainer","supplierTerm"],
    ocean: ["oceanRubPerContainer","supplierTerm"],
    insurance: ["insuranceRubPerContainer","supplierTerm"],
    destPort: ["destPortUsdPerContainer","usdRub"],
    inland: ["inlandRubPerContainer"],
    customsFee: ["customsFeeRubPerContainer"],
    broker: ["brokerFeeRubPerContainer"],

    marking: ["markingServiceRubPerBottle"],
    egais: ["egaisOpsRubPerBottle"],
    otherOps: ["otherOpsRubPerBottle"],

    supplier: ["supplierPriceRubPerBottle","supplierTerm"]
  };

  // mode: "hover" = highlight only; "click" = highlight + focus + scroll
  function highlightInputsForKey(key, mode = "hover"){
    clearHighlights();
    const ids = keyToInputs[key] || [];
    if (!ids.length) return;

    ids.forEach(id=>{
      const row = document.querySelector(`.row[data-row="${id}"]`);
      if (row) row.classList.add("active");
    });

    if (mode === "click"){
      const first = $(ids[0]);
      if (first && (first.tagName === "INPUT" || first.tagName === "SELECT")){
        first.focus({preventScroll:true});
        first.scrollIntoView({behavior:"smooth", block:"center"});
      }
    }
  }

  function payableCostsPerBottle(term, inp){
    const bpc = inp.bottlesPerContainer;

    const origin = (term === "EXW") ? (inp.originRubPerContainer / bpc) : 0;
    const ocean  = (term === "EXW" || term === "FOB") ? (inp.oceanRubPerContainer / bpc) : 0;
    const ins    = (term === "EXW" || term === "FOB") ? (inp.insuranceRubPerContainer / bpc) : 0;

    const destPort = (inp.destPortUsdPerContainer * inp.usdRub) / bpc;
    const inland   = inp.inlandRubPerContainer / bpc;
    const customs  = inp.customsFeeRubPerContainer / bpc;
    const broker   = inp.brokerFeeRubPerContainer / bpc;

    const marking  = inp.markingServiceRubPerBottle;
    const egais    = inp.egaisOpsRubPerBottle;
    const otherOps = inp.otherOpsRubPerBottle;

    return {
      origin, ocean, ins, destPort, inland, customs, broker,
      marking, egais, otherOps,
      logTotal: origin + ocean + ins + destPort + inland + customs + broker,
      opsTotal: marking + egais + otherOps,
      total: origin + ocean + ins + destPort + inland + customs + broker + marking + egais + otherOps
    };
  }

  function govCostsPerBottle(inp){
    const excise = inp.exciseRubPerLiter * inp.bottleLiters;
    const duty   = inp.dutyEurPerLiter * inp.bottleLiters * inp.eurRub;
    const cz     = inp.czCodeRub;
    return { excise, duty, cz, total: excise + duty + cz };
  }

  function setTooltip(show, x=0, y=0, html=""){
    const tt = $("tooltip");
    if (!show){
      tt.style.display = "none";
      return;
    }
    tt.innerHTML = html;
    tt.style.display = "block";
    const pad = 14;
    let left = x + pad;
    let top  = y + pad;
    const rect = tt.getBoundingClientRect();
    if (left + rect.width > window.innerWidth - 10) left = x - rect.width - pad;
    if (top + rect.height > window.innerHeight - 10) top = y - rect.height - pad;
    tt.style.left = left + "px";
    tt.style.top  = top + "px";
  }

  function absPack(valPerBottle, inp){
    const bpc = inp.bottlesPerContainer;
    const bpm = bpc * inp.containersPerMonth;
    const bpy = bpm * 12;
    return {
      bottle: valPerBottle,
      cont: valPerBottle * bpc,
      month: valPerBottle * bpm,
      year: valPerBottle * bpy
    };
  }

  function tooltipHtml(label, valPerBottle, inp){
    const a = absPack(valPerBottle, inp);
    return `
      <div class="h">${label}</div>
      <div class="m mono">
        на бут: <b>${fmt(a.bottle,2)} ₽</b><br>
        на конт: <b>${fmt(a.cont,0)} ₽</b><br>
        на мес: <b>${fmt(a.month,0)} ₽</b><br>
        на год: <b>${fmt(a.year,0)} ₽</b>
      </div>
    `;
  }

  // mode: hover/click
  function setSelection(key, label, valPerBottle, inp, mode="hover"){
    const a = absPack(valPerBottle, inp);
    $("selName").textContent = label;
    $("selVals").innerHTML =
      `на бут: <b>${fmt(a.bottle,2)} ₽</b><br>` +
      `на конт: <b>${fmt(a.cont,0)} ₽</b><br>` +
      `на мес: <b>${fmt(a.month,0)} ₽</b><br>` +
      `на год: <b>${fmt(a.year,0)} ₽</b>`;

    // tiles highlight
    document.querySelectorAll(".tile").forEach(t => t.classList.remove("active"));
    const tile = document.querySelector(`.tile[data-key="${key}"]`);
    if (tile) tile.classList.add("active");

    // inputs highlight: no scroll on hover
    highlightInputsForKey(key, mode);
  }

  function buildMainBar(segments, sellExVat, inp){
    const bar = $("mainBar");
    bar.innerHTML = "";

    const denom = Math.max(0.0001, sellExVat);
    const toPct = (v)=> Math.max(0, (v/denom)*100);

    segments.forEach(seg=>{
      const w = toPct(seg.value);
      if (w <= 0) return;

      const s = document.createElement("span");
      s.className = "seg";
      s.tabIndex = 0;
      s.style.width = w.toFixed(4) + "%";
      s.style.background = seg.color;
      s.dataset.key = seg.key;

      const tipHtml = tooltipHtml(seg.label, seg.value, inp);

      // Hover: tooltip + highlight only
      s.addEventListener("mousemove", (e)=> setTooltip(true, e.clientX, e.clientY, tipHtml));
      s.addEventListener("mouseleave", ()=> { if (!pinnedKey) setTooltip(false); });
      s.addEventListener("mouseenter", ()=>{
        if (!pinnedKey) setSelection(seg.key, seg.label, seg.value, inp, "hover");
      });

      // Click: pin + go to inputs (scroll)
      s.addEventListener("click", ()=>{
        const wasPinned = (pinnedKey === seg.key);
        pinnedKey = wasPinned ? null : seg.key;

        if (!wasPinned){
          setSelection(seg.key, seg.label, seg.value, inp, "click");
        } else {
          setSelection(seg.key, seg.label, seg.value, inp, "hover");
        }
      });

      s.addEventListener("keydown",(e)=>{
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          s.click();
        }
      });

      bar.appendChild(s);
    });
  }

  function buildTiles(items, inp){
    const grid = $("detailGrid");
    grid.innerHTML = "";

    items.forEach(it=>{
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.dataset.key = it.key;

      tile.innerHTML = `
        <div class="t">${it.group}</div>
        <div class="v mono">${it.label}: ${fmt(it.value,2)} ₽/бут</div>
        <div class="c"><span class="pill" style="background:${it.color}"></span><span class="mono">${fmt(it.value * inp.bottlesPerContainer,0)} ₽/конт</span></div>
      `;

      const tip = tooltipHtml(it.label, it.value, inp);

      // Hover: tooltip + highlight only
      tile.addEventListener("mousemove", (e)=> setTooltip(true, e.clientX, e.clientY, tip));
      tile.addEventListener("mouseleave", ()=> { if (!pinnedKey) setTooltip(false); });
      tile.addEventListener("mouseenter", ()=>{
        if (!pinnedKey) setSelection(it.key, it.label, it.value, inp, "hover");
      });

      // Click: pin + go to inputs (scroll)
      tile.addEventListener("click", ()=>{
        const wasPinned = (pinnedKey === it.key);
        pinnedKey = wasPinned ? null : it.key;

        if (!wasPinned){
          setSelection(it.key, it.label, it.value, inp, "click");
        } else {
          setSelection(it.key, it.label, it.value, inp, "hover");
        }
      });

      grid.appendChild(tile);
    });
  }

  function calc(){
    const inp = getInputs();

    const sellExVat = inp.sellPriceVat / (1 + inp.vatRate);

    const bottlesPerMonth = inp.bottlesPerContainer * inp.containersPerMonth;
    const bottlesPerYear  = bottlesPerMonth * 12;
    const containersPerYear = inp.containersPerMonth * 12;

    const targetNetPerBottle = inp.targetNetProfitYear / Math.max(1, bottlesPerYear);
    const targetPBTPerBottle = targetNetPerBottle / Math.max(0.0001, (1 - inp.profitTaxRate));

    const gov = govCostsPerBottle(inp);

    const payEXW = payableCostsPerBottle("EXW", inp);
    const payFOB = payableCostsPerBottle("FOB", inp);
    const payCIF = payableCostsPerBottle("CIF", inp);

    const maxSupplier = (pay) => sellExVat - targetPBTPerBottle - gov.total - pay.total;

    const maxEXW = maxSupplier(payEXW);
    const maxFOB = maxSupplier(payFOB);
    const maxCIF = maxSupplier(payCIF);

    // factual scenario
    const paySel = payableCostsPerBottle(inp.supplierTerm, inp);
    const supplier = inp.supplierPriceRubPerBottle;

    const totalCostBottle = supplier + gov.total + paySel.total;
    const pbtBottle = sellExVat - totalCostBottle;
    const netBottle = pbtBottle * (1 - inp.profitTaxRate);

    const revBottle = sellExVat;
    const revCont = revBottle * inp.bottlesPerContainer;
    const revYear = revBottle * bottlesPerYear;

    const costCont = totalCostBottle * inp.bottlesPerContainer;
    const costYear = totalCostBottle * bottlesPerYear;

    const pbtCont = pbtBottle * inp.bottlesPerContainer;
    const pbtYear = pbtBottle * bottlesPerYear;

    const netCont = netBottle * inp.bottlesPerContainer;
    const netYear = netBottle * bottlesPerYear;

    // KPIs
    $("outSellExVat").textContent = fmt(sellExVat, 2) + " ₽";
    $("outSellExVatInline").textContent = fmt(sellExVat, 2) + " ₽/бут";
    $("outTerm").textContent = inp.supplierTerm;

    $("outVolumeYear").textContent = fmt0(bottlesPerYear) + " бут / " + fmt0(containersPerYear) + " конт";
    $("outTargetPBTPerBottle").textContent = fmt(targetPBTPerBottle, 2) + " ₽";

    $("maxEXW").textContent = fmt(maxEXW, 2) + " ₽";
    $("maxFOB").textContent = fmt(maxFOB, 2) + " ₽";
    $("maxCIF").textContent = fmt(maxCIF, 2) + " ₽";

    $("revBottle").textContent = fmt(revBottle, 2) + " ₽";
    $("revCont").textContent   = fmt(revCont, 0) + " ₽";
    $("revYear").textContent   = fmt(revYear, 0) + " ₽";

    $("costBottle").textContent = fmt(totalCostBottle, 2) + " ₽";
    $("costCont").textContent   = fmt(costCont, 0) + " ₽";
    $("costYear").textContent   = fmt(costYear, 0) + " ₽";

    $("pbtBottle").textContent = fmt(pbtBottle, 2) + " ₽";
    $("pbtCont").textContent   = fmt(pbtCont, 0) + " ₽";
    $("pbtYear").textContent   = fmt(pbtYear, 0) + " ₽";

    $("netBottle").textContent = fmt(netBottle, 2) + " ₽";
    $("netCont").textContent   = fmt(netCont, 0) + " ₽";
    $("netYear").textContent   = fmt(netYear, 0) + " ₽";

    // goal KPI
    const diff = netYear - inp.targetNetProfitYear;
    const ok = diff >= 0;
    $("goalKpi").innerHTML = `<span class="${ok ? "ok":"bad"}">${ok ? "OK":"НЕ OK"}</span>`;
    $("goalKpiSub").innerHTML = `<span class="${ok ? "ok":"bad"}">${ok ? "запас":"дефицит"} ${fmt(Math.abs(diff),0)} ₽</span>`;

    // Main bar segments (high level)
    const supplierSeg = { key:"supplier_total", label:"Поставщик (итого)", value: Math.max(0, supplier), color:"var(--c-supplier)" };
    const govSeg = { key:"gov_total", label:"Гос.платежи (итого)", value: Math.max(0, gov.total), color:"var(--c-gov)" };
    const logSeg = { key:"log_total", label:"Логистика/таможня (итого)", value: Math.max(0, paySel.logTotal), color:"var(--c-log)" };
    const opsSeg = { key:"ops_total", label:"Маркировка/операции (итого)", value: Math.max(0, paySel.opsTotal), color:"var(--c-ops)" };

    const profitSeg = pbtBottle >= 0
      ? { key:"profit", label:"Прибыль до налога", value: pbtBottle, color:"var(--c-profit)" }
      : { key:"loss", label:"Убыток (дефицит)", value: -pbtBottle, color:"var(--c-loss)" };

    buildMainBar([supplierSeg, govSeg, logSeg, opsSeg, profitSeg], sellExVat, inp);

    $("mainBarText").textContent =
      `Выручка без НДС: ${fmt(sellExVat,2)} ₽/бут. Себестоимость: ${fmt(totalCostBottle,2)} ₽/бут. PBT: ${fmt(pbtBottle,2)} ₽/бут.`;

    // Detail tiles
    const tiles = [];

    // GOV
    tiles.push({ key:"excise", group:"Гос.платежи", label:"Акциз", value: gov.excise, color:"var(--c-gov)" });
    tiles.push({ key:"duty", group:"Гос.платежи", label:"Пошлина", value: gov.duty, color:"var(--c-gov)" });
    tiles.push({ key:"czcode", group:"Гос.платежи", label:"Код ЧЗ", value: gov.cz, color:"var(--c-gov)" });

    // LOG (term dependent)
    tiles.push({ key:"origin", group:"Логистика/таможня", label:"Origin/local", value: paySel.origin, color:"var(--c-log)" });
    tiles.push({ key:"ocean", group:"Логистика/таможня", label:"Ocean freight", value: paySel.ocean, color:"var(--c-log)" });
    tiles.push({ key:"insurance", group:"Логистика/таможня", label:"Страхование", value: paySel.ins, color:"var(--c-log)" });
    tiles.push({ key:"destPort", group:"Логистика/таможня", label:"Порт РФ (THC)", value: paySel.destPort, color:"var(--c-log)" });
    tiles.push({ key:"inland", group:"Логистика/таможня", label:"Логистика РФ", value: paySel.inland, color:"var(--c-log)" });
    tiles.push({ key:"customsFee", group:"Логистика/таможня", label:"Тамож.сбор", value: paySel.customs, color:"var(--c-log)" });
    tiles.push({ key:"broker", group:"Логистика/таможня", label:"Брокер", value: paySel.broker, color:"var(--c-log)" });

    // OPS
    tiles.push({ key:"marking", group:"Маркировка/операции", label:"Маркировка (услуга)", value: paySel.marking, color:"var(--c-ops)" });
    tiles.push({ key:"egais", group:"Маркировка/операции", label:"ЕГАИС/операции", value: paySel.egais, color:"var(--c-ops)" });
    tiles.push({ key:"otherOps", group:"Маркировка/операции", label:"Прочие операции", value: paySel.otherOps, color:"var(--c-ops)" });

    // Supplier & Profit
    tiles.push({ key:"supplier", group:"Поставщик", label:"Цена поставщика", value: supplier, color:"var(--c-supplier)" });
    tiles.push({ key:(pbtBottle>=0 ? "profit":"loss"), group:"Прибыль", label:(pbtBottle>=0 ? "PBT (прибыль)":"PBT (убыток)"), value: Math.abs(pbtBottle), color:(pbtBottle>=0 ? "var(--c-profit)":"var(--c-loss)") });

    buildTiles(tiles, inp);

    // IMPORTANT: do NOT scroll on recalculation. If pinned, keep selection in hover-mode.
    if (pinnedKey){
      const found = tiles.find(t=>t.key===pinnedKey);
      if (found){
        setSelection(found.key, found.label, found.value, inp, "hover");
      } else {
        const map = { supplier_total:supplierSeg, gov_total:govSeg, log_total:logSeg, ops_total:opsSeg, profit:profitSeg, loss:profitSeg };
        const g = map[pinnedKey];
        if (g) setSelection(g.key, g.label, g.value, inp, "hover");
      }
    }
  }

  function bind(){
    const all = document.querySelectorAll("input, select");
    all.forEach(el => el.addEventListener("input", calc));
    all.forEach(el => el.addEventListener("change", calc));

    $("btnReset").addEventListener("click", ()=>{
      for (const [k,v] of Object.entries(defaults)){
        const el = $(k);
        if (!el) continue;
        if (el.tagName === "SELECT") el.value = v;
        else el.value = v;
      }
      pinnedKey = null;
      $("selName").textContent = "—";
      $("selVals").textContent = "Наведись или кликни по сегменту/плитке";
      setTooltip(false);
      clearHighlights();
      calc();
    });

    $("btnSave").addEventListener("click", ()=>{
      const data = getInputs();
      localStorage.setItem("corona_dash_inputs_v3", JSON.stringify(data));
      alert("Сохранено в браузере (localStorage).");
    });

    $("btnLoad").addEventListener("click", ()=>{
      const raw = localStorage.getItem("corona_dash_inputs_v3");
      if (!raw) { alert("Нет сохранённых данных."); return; }
      const data = JSON.parse(raw);
      for (const [k,v] of Object.entries(data)){
        const el = $(k);
        if (!el) continue;
        if (el.tagName === "SELECT") el.value = v;
        else el.value = v;
      }
      pinnedKey = null;
      $("selName").textContent = "—";
      $("selVals").textContent = "Наведись или кликни по сегменту/плитке";
      setTooltip(false);
      clearHighlights();
      calc();
    });

    $("btnClearSel").addEventListener("click", ()=>{
      pinnedKey = null;
      $("selName").textContent = "—";
      $("selVals").textContent = "Наведись или кликни по сегменту/плитке";
      setTooltip(false);
      clearHighlights();
    });

    window.addEventListener("scroll", ()=> { if (!pinnedKey) setTooltip(false); });
  }

  (function init(){
    bind();
    calc();
  })();
</script>
</body>
</html>
